{% extends "base.html" %}

{% block title %}Share Surplus Food - MealMap{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Share Surplus Food</h1>
            <p class="text-gray-600">Help reduce food waste and feed those in need</p>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <form method="POST" action="{{ url_for('add_surplus_food') }}">
                <!-- Food Title -->
                <div class="mb-6">
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        Food Title <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="title" name="title" required placeholder="e.g., Fresh Vegetables, Cooked Rice"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-green focus:border-transparent">
                </div>

                <!-- Food Type -->
                <div class="mb-6">
                    <label for="cost_type" class="block text-sm font-medium text-gray-700 mb-2">
                        Food Type <span class="text-red-500">*</span>
                    </label>
                    <select id="cost_type" name="cost_type" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-green focus:border-transparent">
                        <option value="">Select food type</option>
                        <option value="free">Free</option>
                        <option value="discounted">Discounted</option>
                    </select>
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Description <span class="text-red-500">*</span>
                    </label>
                    <textarea id="description" name="description" required rows="4"
                              placeholder="Describe the food, quantity, serving size, any allergens, pickup instructions..."
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-green focus:border-transparent resize-none"></textarea>
                </div>

                <!-- Expiry Date & Time -->
                <div class="mb-6">
                    <label for="expiry_datetime" class="block text-sm font-medium text-gray-700 mb-2">
                        Expiry Date & Time <span class="text-red-500">*</span>
                    </label>
                    <input type="datetime-local" id="expiry_datetime" name="expiry_datetime" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-green focus:border-transparent">
                    <p class="text-sm text-gray-500 mt-1">When will this food no longer be available for pickup?</p>
                </div>

                <!-- Image URL (Optional) -->
                <div class="mb-6">
                    <label for="image_url" class="block text-sm font-medium text-gray-700 mb-2">
                        Image URL (Optional)
                    </label>
                    <input type="url" id="image_url" name="image_url"
                           placeholder="https://postimg.cc/your-image or https://imgur.com/your-image"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-green focus:border-transparent">
                    <p class="text-sm text-gray-500 mt-1">Direct link to an image from Postimg, Imgur, etc.</p>
                </div>

                <!-- Location -->
                <div class="mb-8">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center mb-3">
                            <i class="bi bi-geo-alt text-blue-600 mr-2"></i>
                            <h3 class="font-medium text-gray-900">Pickup Location <span class="text-red-500">*</span></h3>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="location_type" value="pin" class="mr-2" checked>
                                    <span class="text-sm">Pin on Map</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="radio" name="location_type" value="current" class="mr-2">
                                    <span class="text-sm">Use Current Location</span>
                                </label>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2 mb-3">Click the map to mark the exact pickup location</p>
                        <div id="map" style="height: 300px;" class="rounded-lg border border-gray-300"></div>
                        <input type="hidden" id="lat" name="lat" required>
                        <input type="hidden" id="lon" name="lon" required>
                        <div id="location-status" class="mt-2 text-sm"></div>
                    </div>
                </div>

                <input type="hidden" name="category" value="Food">

                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-primary-green text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-600 transition-all duration-300 shadow-lg hover:shadow-xl">
                        <i class="bi bi-share mr-2"></i>
                        Share Food
                    </button>
                    <a href="{{ url_for('posts') }}" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-all duration-300 text-center">
                        <i class="bi bi-x-circle mr-2"></i>
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        if (typeof L === 'undefined') {
            var script = document.createElement('script');
            script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
            script.onload = initializeMap;
            document.head.appendChild(script);
        } else {
            initializeMap();
        }

        function initializeMap() {
            let map = L.map('map').setView([10.0261, 76.3125], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            let marker = null;
            const latInput = document.getElementById('lat');
            const lonInput = document.getElementById('lon');
            const locationStatus = document.getElementById('location-status');

            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker([lat, lng]).addTo(map);
                latInput.value = lat;
                lonInput.value = lng;
                locationStatus.innerHTML = '<span class="text-green-600"><i class="bi bi-check-circle mr-1"></i>Location selected</span>';
            });

            document.querySelector('input[value="current"]').addEventListener('change', function() {
                if (this.checked) {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            map.setView([lat, lng], 15);
                            if (marker) {
                                map.removeLayer(marker);
                            }
                            marker = L.marker([lat, lng]).addTo(map);
                            latInput.value = lat;
                            lonInput.value = lng;
                            locationStatus.innerHTML = '<span class="text-green-600"><i class="bi bi-check-circle mr-1"></i>Current location selected</span>';
                        }, function() {
                            locationStatus.innerHTML = '<span class="text-red-600"><i class="bi bi-exclamation-circle mr-1"></i>Could not get current location</span>';
                        });
                    }
                }
            });

            document.getElementById('expiry_datetime').min = new Date().toISOString().slice(0, 16);
        }
    </script>
{% endblock %}